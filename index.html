<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>家庭留言板 · 实时在线</title>
  <style>
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'PingFang SC','Noto Sans SC',sans-serif;margin:0;background:#f7f7fb;color:#222;}
    .wrap{max-width:760px;margin:24px auto;padding:16px;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .online{font-size:14px;color:#444;}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04);}
    #messageList{list-style:none;padding:0;margin:0;max-height:320px;overflow:auto;}
    #messageList li{padding:8px 10px;border-bottom:1px dashed #eee;word-break:break-word;}
    .meta{color:#666;font-size:12px;margin-right:8px;}
    form{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    input[type=text]{flex:1;min-width:220px;padding:10px;border:1px solid #ddd;border-radius:8px;outline:none;}
    button{padding:10px 16px;border:0;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .tip{font-size:12px;color:#777;margin-left:4px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h2 style="margin:0">家庭留言板</h2>
      <div class="online" id="onlineList">当前无人在线</div>
    </header>

    <div class="card">
      <div class="row">
        <label>昵称</label>
        <input id="nameInput" type="text" placeholder="输入你的昵称" />
        <span class="tip">留空将使用默认昵称</span>
      </div>
      <ul id="messageList" class="card" style="margin:12px 0 0 0"></ul>
      <form id="sendForm" autocomplete="off">
        <input id="messageInput" type="text" maxlength="500" placeholder="说点什么…" />
        <button id="sendBtn" type="submit">发送</button>
      </form>
    </div>

    <div class="tip">提示：同时打开两个浏览器页面测试，发言和在线人数会实时同步。</div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // 你的 Firebase 配置（已替换为你给的）
    const firebaseConfig = {
      apiKey: "AIzaSyDTsjNPdZntfabyVn0q-9y39l9a1ur_cEw",
      authDomain: "jiatingliuyanban-635f9.firebaseapp.com",
      databaseURL: "https://jiatingliuyanban-635f9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "jiatingliuyanban-635f9",
      storageBucket: "jiatingliuyanban-635f9.firebasestorage.app",
      messagingSenderId: "196518556157",
      appId: "1:196518556157:web:f710ec71f8acb4eb79a994"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 身份和昵称
    const uid = localStorage.getItem('uid') || (Date.now().toString(36) + Math.random().toString(36).slice(2));
    localStorage.setItem('uid', uid);
    const nameInput = document.getElementById('nameInput');
    const savedName = localStorage.getItem('nickname');
    if (savedName) nameInput.value = savedName;
    const getName = () => {
      const v = (nameInput.value || '').trim();
      const n = v || ('游客' + uid.slice(-4));
      if (v) localStorage.setItem('nickname', v);
      return n;
    };

    // 数据库引用
    const messagesRef = db.ref('messages');
    const statusRef   = db.ref('status/' + uid);
    const onlineRef   = db.ref('status');
    const connectedRef= db.ref('.info/connected');

    // 发送消息
    const form = document.getElementById('sendForm');
    const input = document.getElementById('messageInput');
    const btn = document.getElementById('sendBtn');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = (input.value || '').trim();
      if (!text) return;
      btn.disabled = true;
      try {
        await messagesRef.push({
          uid,
          name: getName(),
          text,
          ts: firebase.database.ServerValue.TIMESTAMP
        });
        input.value = '';
      } finally {
        btn.disabled = false;
      }
    });

    // 实时渲染消息
    const list = document.getElementById('messageList');
    messagesRef.limitToLast(200).on('child_added', snap => {
      const m = snap.val();
      const li = document.createElement('li');
      const time = new Date(m.ts || Date.now());
      li.innerHTML = `<span class="meta">${time.toLocaleString()}</span><strong>${escapeHtml(m.name)}：</strong> ${linkify(escapeHtml(m.text))}`;
      list.appendChild(li);
      list.scrollTop = list.scrollHeight;
    });

    // 在线状态
    connectedRef.on('value', (snap) => {
      if (snap.val() === true) {
        statusRef.onDisconnect().remove();
        statusRef.set({ name: getName(), lastSeen: firebase.database.ServerValue.TIMESTAMP });
      }
    });
    setInterval(() => {
      statusRef.update({ name: getName(), lastSeen: firebase.database.ServerValue.TIMESTAMP });
    }, 30000);

    const onlineEl = document.getElementById('onlineList');
    onlineRef.on('value', (snap) => {
      const now = Date.now();
      const alive = [];
      snap.forEach(child => {
        const v = child.val();
        if (v && v.lastSeen && (now - v.lastSeen) < 45000) alive.push(v.name);
      });
      onlineEl.textContent = alive.length ? `在线（${alive.length}）：` + alive.join('、') : '当前无人在线';
    });

    // 工具函数
    function escapeHtml(s){
      return s.replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]));
    }
    function linkify(s){
      return s.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    }
  </script>
</body>
</html>
