
    <!-- 用户信息 -->
    <div class="card">
      <div class="topbar">
        <div class="userbox">
          <div id="meAvatar" class="avatar">🙂</div>
          <div>
            <div id="meName" class="name">未知</div>
            <div class="muted">留言会在 48 小时后自动清除</div>
          </div>
        </div>
        <div class="actions">
          <!-- API状态指示器 -->
          <div id="apiStatusIndicator"
            style="display:flex; align-items:center; gap:6px; padding:6px 10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; margin-right:8px;">
            <div id="apiStatusDot" style="width:6px; height:6px; border-radius:50%; background:#ef4444;"></div>
            <span id="apiStatusText" style="font-size:11px; color:#64748b;">API未配置</span>
          </div>
          <button id="quickApiBtn" class="config" onclick="openQuickApiSetup()"
            style="margin-right:4px; background:#10b981; border-color:#10b981;">🔑 设置API</button>
          <button id="configBtn" class="config" onclick="openConfigPanel()">⚙️ 配置</button>
          <button id="logoutBtn" class="logout">退出</button>
        </div>
      </div>
    </div>
    <div id="configModal"
      style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000; align-items:center; justify-content:center;">
      <div
        style="background:#fff; width:680px; max-width:90%; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden;">
        <div
          style="padding:14px 18px; border-bottom:1px solid #eee; font-weight:600; display:flex; align-items:center; justify-content:space-between;">
          <span>AI 配置</span>
          <div style="display:flex; gap:8px;">
            <button onclick="switchConfigTab('ai')" id="aiConfigTab" class="config-tab active"
              style="padding:4px 12px; border:1px solid #ddd; background:#f8fafc; border-radius:6px; font-size:12px; cursor:pointer;">AI参数</button>
            <button onclick="switchConfigTab('api')" id="apiConfigTab" class="config-tab"
              style="padding:4px 12px; border:1px solid #ddd; background:#fff; border-radius:6px; font-size:12px; cursor:pointer;">API密钥</button>
          </div>
        </div>

        <!-- AI参数配置面板 -->
        <div id="aiConfigPanel" class="config-panel"
          style="padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
            <span>温度 (0-1)</span>
            <input id="cfg_temperature" type="number" min="0" max="1" step="0.05"
              style="padding:8px; border:1px solid #ddd; border-radius:8px;" />
          </label>
          <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
            <span>最大Tokens</span>
            <input id="cfg_max_tokens" type="number" min="100" max="4000" step="50"
              style="padding:8px; border:1px solid #ddd; border-radius:8px;" />
          </label>
          <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
            <span>验证窗口大小</span>
            <input id="cfg_windowSize" type="number" min="3" max="50" step="1"
              style="padding:8px; border:1px solid #ddd; border-radius:8px;" />
          </label>
          <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
            <span>最低胜率阈值 (%)</span>
            <input id="cfg_minWinRate" type="number" min="10" max="100" step="1"
              style="padding:8px; border:1px solid #ddd; border-radius:8px;" />
          </label>
          <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
            <span>调整模式</span>
            <select id="cfg_adjustMode" style="padding:8px; border:1px solid #ddd; border-radius:8px;">
              <option value="conservative">保守</option>
              <option value="aggressive">激进</option>
            </select>
          </label>
          <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
            <span>推理深度</span>
            <input id="cfg_reasoningDepth" type="number" min="1" max="10" step="1"
              style="padding:8px; border:1px solid #ddd; border-radius:8px;" />
          </label>
        </div>

        <!-- API密钥配置面板 -->
        <div id="apiConfigPanel" class="config-panel" style="padding:16px; display:none;">
          <!-- API提供商选择 -->
          <div style="margin-bottom:16px;">
            <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
              <span>API提供商</span>
              <select id="apiProvider" onchange="onProviderChange()"
                style="padding:8px; border:1px solid #ddd; border-radius:8px; width:100%;">
                <option value="openrouter">OpenRouter</option>
                <option value="anthropic">Anthropic Claude</option>
                <option value="openai">OpenAI</option>
                <option value="custom">自定义API</option>
              </select>
            </label>
          </div>

          <!-- API密钥输入区域 -->
          <div id="apiKeySection" style="margin-bottom:16px;">
            <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
              <span>API密钥</span>
              <div style="display:flex; gap:8px;">
                <input id="apiKey" type="password" placeholder="请输入API密钥"
                  style="flex:1; padding:8px; border:1px solid #ddd; border-radius:8px;" />
                <button id="toggleApiKey" onclick="toggleApiKeyVisibility()"
                  style="padding:8px; border:1px solid #ddd; background:#f8fafc; border-radius:8px; cursor:pointer;">👁️</button>
              </div>
              <div id="apiKeyHint" style="font-size:11px; color:#64748b; margin-top:4px;"></div>
            </label>
          </div>

          <!-- 自定义API配置 -->
          <div id="customApiSection" style="display:none; margin-bottom:16px;">
            <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
              <span>API端点URL</span>
              <input id="customApiUrl" type="url" placeholder="https://api.example.com/v1"
                style="padding:8px; border:1px solid #ddd; border-radius:8px;" />
            </label>
          </div>

          <!-- API状态显示 -->
          <div id="apiStatusSection"
            style="margin-bottom:16px; padding:12px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
              <span style="font-size:12px; font-weight:600;">API状态</span>
              <button onclick="testApiConnection()"
                style="padding:4px 8px; border:1px solid #3b82f6; background:#3b82f6; color:#fff; border-radius:6px; font-size:11px; cursor:pointer;">测试连接</button>
            </div>
            <div id="apiStatusDisplay" style="font-size:11px; color:#64748b;">
              未配置API密钥
            </div>
          </div>

          <!-- 模型状态显示 -->
          <div id="modelStatusSection"
            style="margin-bottom:16px; padding:12px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
              <span style="font-size:12px; font-weight:600;">可用模型</span>
              <button onclick="testAvailableModels()"
                style="padding:4px 8px; border:1px solid #10b981; background:#10b981; color:#fff; border-radius:6px; font-size:11px; cursor:pointer;">检测模型</button>
            </div>
            <div id="modelStatusDisplay" style="font-size:11px; color:#64748b;">
              点击"检测模型"查看可用模型
            </div>
          </div>

          <!-- 快速配置模板 -->
          <div style="margin-bottom:16px;">
            <div style="font-size:12px; font-weight:600; margin-bottom:8px;">快速配置</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
              <button onclick="applyApiTemplate('openrouter')"
                style="padding:8px; border:1px solid #ddd; background:#f8fafc; border-radius:6px; font-size:11px; cursor:pointer; text-align:left;">
                <div style="font-weight:600;">OpenRouter</div>
                <div style="color:#64748b; font-size:10px;">多模型聚合平台</div>
              </button>
              <button onclick="applyApiTemplate('anthropic')"
                style="padding:8px; border:1px solid #ddd; background:#f8fafc; border-radius:6px; font-size:11px; cursor:pointer; text-align:left;">
                <div style="font-weight:600;">Anthropic</div>
                <div style="color:#64748b; font-size:10px;">Claude官方API</div>
              </button>
            </div>
          </div>
        </div>

        <div style="padding:12px 16px; border-top:1px solid #eee; display:flex; gap:8px; justify-content:flex-end;">
          <button onclick="closeConfigPanel()"
            style="padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:8px;">取消</button>
          <button onclick="saveConfigChanges()"
            style="padding:8px 12px; border:0; background:#3b82f6; color:#fff; border-radius:8px;">保存</button>
        </div>
      </div>
    </div>

    <!-- 快速API设置弹窗 -->
    <div id="quickApiModal"
      style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1001; align-items:center; justify-content:center;">
      <div
        style="background:#fff; width:480px; max-width:90%; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden;">
        <div style="padding:16px; border-bottom:1px solid #eee; font-weight:600; text-align:center;">
          🔑 快速设置API密钥
        </div>
        <div style="padding:20px;">
          <div style="margin-bottom:16px; text-align:center;">
            <div style="font-size:14px; margin-bottom:8px; color:#1e293b;">选择您的API提供商</div>
            <div style="font-size:12px; color:#64748b; line-height:1.4;">
              配置API密钥即可开始使用AI预测功能
            </div>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
            <button onclick="selectApiProvider('openrouter')"
              style="padding:12px; border:2px solid #e2e8f0; background:#f8fafc; border-radius:8px; cursor:pointer; transition:all 0.2s;">
              <div style="font-weight:600; margin-bottom:4px;">🌐 OpenRouter</div>
              <div style="font-size:11px; color:#64748b; line-height:1.3;">多模型聚合平台<br />支持多种免费模型</div>
            </button>
            <button onclick="selectApiProvider('anthropic')"
              style="padding:12px; border:2px solid #e2e8f0; background:#f8fafc; border-radius:8px; cursor:pointer; transition:all 0.2s;">
              <div style="font-weight:600; margin-bottom:4px;">🧠 Anthropic</div>
              <div style="font-size:11px; color:#64748b; line-height:1.3;">Claude官方API<br />高质量AI对话</div>
            </button>
          </div>

          <div id="quickApiKeySection" style="display:none; margin-bottom:16px;">
            <label style="display:flex; flex-direction:column; gap:6px; font-size:12px;">
              <span>API密钥</span>
              <input id="quickApiKey" type="password" placeholder="请输入您的API密钥"
                style="padding:10px; border:1px solid #ddd; border-radius:8px; font-size:12px;" />
              <div id="quickApiHint" style="font-size:11px; color:#64748b;"></div>
            </label>
          </div>

          <div id="quickApiActions" style="display:flex; gap:8px; justify-content:flex-end;">
            <button onclick="closeQuickApiSetup()"
              style="padding:8px 16px; border:1px solid #ddd; background:#fff; border-radius:8px;">取消</button>
            <button id="quickApiTestBtn" onclick="testQuickApiKey()"
              style="display:none; padding:8px 16px; border:1px solid #f59e0b; background:#f59e0b; color:#fff; border-radius:8px;">测试连接</button>
            <button id="quickApiSaveBtn" onclick="saveQuickApiKey()"
              style="display:none; padding:8px 16px; border:0; background:#10b981; color:#fff; border-radius:8px;">保存并启用</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 在线列表 -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="name">当前在线</div>
        <div class="muted">1 分钟内活跃视为在线</div>
      </div>
      <div id="presence" class="presence" style="margin-top:8px;"></div>
    </div>

    <!-- 结果资讯模块 -->
    <div class="card">
      <h3>🧧 结果资讯</h3>
      <label for="gameSelect">选择游戏：</label>
      <select id="gameSelect">
        <option value="1">香港</option>
        <option value="4">新澳门</option>
      </select>
      <div id="lotteryInfo">载入中...</div>
      <div id="countdown" class="countdown"></div>

      <!-- AI预测功能 -->
      <div class="ai-prediction-section">
        <h4>🤖 AI智能预测 (冠军算法融合版)</h4>
        <p class="prediction-disclaimer">⚠️ 仅供娱乐参考，不构成模拟建议</p>

        <!-- 预测彩种选择 -->
        <div class="prediction-type-selector">
          <label>选择预测彩种：</label>
          <div class="prediction-tabs">
            <button id="hkPredictTab" class="prediction-tab active" data-type="hk">🇭🇰 香港数据分析</button>
            <button id="macauPredictTab" class="prediction-tab" data-type="macau">🇲🇴 澳门数据分析</button>
          </div>
        </div>

        <!-- 香港数字分析 -->
        <div id="hkPrediction" class="prediction-panel active">
          <div class="prediction-info">
            <div class="current-period">当前分析期号: <span id="hkCurrentPeriod">-</span></div>
            <div class="prediction-strategy">
              <div>当前策略: <span id="hkCurrentStrategy" style="font-weight: bold; color: #2196F3;">🏆 冠军算法融合 (Top 3 Fusion)</span></div>
              <div class="strategy-details" id="hkStrategyDetails"
                style="font-size: 12px; color: #666; margin-top: 4px;">
                <span id="hkStrategyComposition">已启用最高胜率策略：基于Top 3算法共振</span>
              </div>
            </div>
          </div>
          
          <button id="hkManualPredictBtn" class="manual-predict-btn" style="margin-top: 10px; width: 100%; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">🔮 开始智能分析</button>
          
          <div id="hkPredictionLoading" class="prediction-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="ai-analysis-steps" id="hkAnalysisSteps">
              <h6>🤖 AI分析推演中...</h6>
              <div class="analysis-step" id="hkStep1">⏳ 初始化8种学术级算法...</div>
              <div class="analysis-step" id="hkStep2" style="opacity: 0.3;">📊 正在并行计算...</div>
              <div class="analysis-step" id="hkStep3" style="opacity: 0.3;">🏆 筛选Top 3冠军算法...</div>
              <div class="analysis-step" id="hkStep4" style="opacity: 0.3;">🔄 执行共振融合 (Fusion)...</div>
              <div class="analysis-step" id="hkStep5" style="opacity: 0.3;">✅ 生成最终结果...</div>
            </div>
          </div>

          <div id="hkPredictionResult" class="prediction-result" style="display: none; margin-top: 20px;">
             <!-- 结果将动态插入这里，包括推算过程的可视化 -->
          </div>

          <div class="prediction-history">
            <h5>📊 分析历史记录</h5>
            <div id="hkPredictionHistory" class="history-list"></div>
          </div>
        </div>

        <!-- 澳门数据分析 -->
        <div id="macauPrediction" class="prediction-panel" style="display: none;">
          <div class="prediction-info">
            <div class="current-period">当前分析期号: <span id="macauCurrentPeriod">-</span></div>
            <div class="prediction-strategy">
              <div>当前策略: <span id="macauCurrentStrategy" style="font-weight: bold; color: #2196F3;">🏆 冠军算法融合 (Top 3 Fusion)</span></div>
              <div class="strategy-details" id="macauStrategyDetails"
                style="font-size: 12px; color: #666; margin-top: 4px;">
                <span id="macauStrategyComposition">已启用最高胜率策略：基于Top 3算法共振</span>
              </div>
            </div>
          </div>
          
          <button id="macauManualPredictBtn" class="manual-predict-btn" style="margin-top: 10px; width: 100%; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">🔮 开始智能分析</button>
          
          <div id="macauPredictionLoading" class="prediction-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="ai-analysis-steps" id="macauAnalysisSteps">
              <h6>🤖 AI分析推演中...</h6>
              <div class="analysis-step" id="macauStep1">⏳ 初始化8种学术级算法...</div>
              <div class="analysis-step" id="macauStep2" style="opacity: 0.3;">📊 正在并行计算...</div>
              <div class="analysis-step" id="macauStep3" style="opacity: 0.3;">🏆 筛选Top 3冠军算法...</div>
              <div class="analysis-step" id="macauStep4" style="opacity: 0.3;">🔄 执行共振融合 (Fusion)...</div>
              <div class="analysis-step" id="macauStep5" style="opacity: 0.3;">✅ 生成最终结果...</div>
            </div>
          </div>

          <div id="macauPredictionResult" class="prediction-result" style="display: none; margin-top: 20px;">
             <!-- 结果将动态插入这里 -->
          </div>

          <div class="prediction-history">
            <h5>📊 分析历史记录</h5>
            <div id="macauPredictionHistory" class="history-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 留言输入 -->
    <div class="card">
      <form id="form" class="composer" autocomplete="off">
        <textarea id="text" placeholder="写下你想说的话（不限制字数）"></textarea>
        <button id="send" type="submit">发送</button>
      </form>
    </div>

    <!-- 留言列表 -->
    <ul id="list"></ul>
  