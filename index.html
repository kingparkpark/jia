<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å®¶åº­ç•™è¨€æ¿</title>
<style>
  :root { --bg:#f7f7f7; --card:#ffffff; --text:#222; --muted:#666; --line:#e5e5e5; --accent:#2b8aef; --ok:#22c55e; --off:#9aa0a6; }
  body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif; max-width: 720px; margin: auto; background: var(--bg); color: var(--text); padding: 24px 16px; }
  h1 { text-align: center; margin: 0 0 12px; }
  .card { background: var(--card); border:1px solid var(--line); border-radius: 12px; padding: 12px; margin: 10px 0; }
  input, button { padding: 10px; font-size: 16px; }
  input[type="password"], input[type="text"] { width: 100%; border:1px solid var(--line); border-radius:10px; }
  button { border:0; border-radius: 10px; background: var(--accent); color: #fff; cursor: pointer; }
  #msgForm { display:flex; gap: 8px; }
  #msgInput { flex: 1; }
  ul { list-style: none; padding: 0; margin: 0; }
  li.msg { background: var(--card); border:1px solid var(--line); border-radius: 12px; padding: 10px; display:flex; gap:10px; margin-bottom: 8px; }
  .avatar { width: 40px; height: 40px; border-radius: 10px; display:grid; place-items:center; font-size: 22px; background:#f0f4ff; }
  .meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .presence-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-top:1px solid var(--line); }
  .presence-item:first-child { border-top: 0; }
  .name { font-weight: 600; }
  .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align: middle; }
  .online { background: var(--ok); }
  .offline { background: var(--off); }
  .header-row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .muted { color: var(--muted); font-size: 12px; }
  .status { display:flex; align-items:center; gap:6px; }
  .pill { border:1px solid var(--line); border-radius: 999px; padding: 6px 10px; }
</style>
</head>
<body>

<h1>å®¶åº­ç•™è¨€æ¿</h1>

<div id="loginArea" class="card">
  <div style="margin-bottom:8px;" class="muted">è¾“å…¥ä½ çš„ä¸“å±å¯†ç è¿›å…¥ï¼ˆä¸åŒå¯†ç ä»£è¡¨ä¸åŒçš„äººï¼‰</div>
  <form id="loginForm">
    <input type="password" id="pwd" placeholder="è¾“å…¥å¯†ç " required>
    <div style="margin-top:10px; display:flex; gap:8px;">
      <button type="submit" style="flex:1;">ç™»å½•</button>
    </div>
  </form>
</div>

<div id="boardArea" style="display:none;">
  <div class="card">
    <div class="header-row">
      <div class="status">
        <div id="meAvatar" class="avatar">ğŸ™‚</div>
        <div>
          <div id="meName" class="name">æˆ‘</div>
          <div class="muted">ç•™è¨€è‡ªåŠ¨åœ¨ 48 å°æ—¶åé”€æ¯</div>
        </div>
      </div>
      <div class="pill muted" id="netStatus"><span class="dot offline"></span>ç½‘ç»œç¦»çº¿</div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:600; margin-bottom:8px;">å®¶åº­åœ¨çº¿çŠ¶æ€</div>
    <div id="presenceList"></div>
  </div>

  <div class="card">
    <form id="msgForm">
      <input type="text" id="msgInput" placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..." required>
      <button type="submit">å‘é€</button>
    </form>
  </div>

  <ul id="msgList"></ul>
</div>

<script>
  // ---- é…ç½®ï¼šç”¨æˆ·ä¸å¯†ç  ----
  const USERS = {
    horse:  { id:'horse',  name:'é©¬',   avatar:'ğŸ' },
    sheep:  { id:'sheep',  name:'ç¾Š',   avatar:'ğŸ‘' },
    mouse:  { id:'mouse',  name:'è€é¼ ', avatar:'ğŸ­' },
    rabbit: { id:'rabbit', name:'å…”å­', avatar:'ğŸ‡' },
    monkey: { id:'monkey', name:'çŒ´å­', avatar:'ğŸ’' },
    snake:  { id:'snake',  name:'è›‡',   avatar:'ğŸ' }
  };
  const PASSWORDS = {
    'ma123':'horse', 'yang123':'sheep', 'shu123':'mouse',
    'tu123':'rabbit','hou123':'monkey','she123':'snake'
  };

  // ---- å¸¸é‡ä¸çŠ¶æ€ ----
  const MSG_KEY = 'familyMsgs';
  const PRESENCE_KEY = 'familyPresence';
  const EXPIRY_HOURS = 48;
  const ONLINE_WINDOW_MS = 60 * 1000; // 1 åˆ†é’Ÿå†…æœ‰å¿ƒè·³åˆ¤å®šä¸ºåœ¨çº¿
  let currentUser = null;

  // ---- å·¥å…·å‡½æ•° ----
  const now = () => Date.now();
  const safeParse = (s, fallback) => { try { return JSON.parse(s); } catch { return fallback; } };

  function loadMessages() {
    const ts = now();
    let msgs = safeParse(localStorage.getItem(MSG_KEY), []);
    msgs = msgs.filter(m => ts - m.time <= EXPIRY_HOURS * 3600 * 1000);
    localStorage.setItem(MSG_KEY, JSON.stringify(msgs));
    return msgs;
  }

  function saveMessage(text) {
    const msgs = loadMessages();
    msgs.unshift({ text, time: now(), userId: currentUser.id });
    localStorage.setItem(MSG_KEY, JSON.stringify(msgs));
  }

  function formatRemaining(ms) {
    const totalSec = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const hh = String(h).padStart(2, '0');
    const mm = String(m).padStart(2, '0');
    return `${hh}å°æ—¶${mm}åˆ†é’Ÿ`;
  }

  function timeAgo(ms) {
    const sec = Math.floor(ms / 1000);
    if (sec < 60) return 'åˆšåˆš';
    const min = Math.floor(sec / 60);
    if (min < 60) return `${min} åˆ†é’Ÿå‰`;
    const h = Math.floor(min / 60);
    if (h < 24) return `${h} å°æ—¶å‰`;
    const d = Math.floor(h / 24);
    return `${d} å¤©å‰`;
  }

  // ---- æ¸²æŸ“æ¶ˆæ¯ ----
  function renderMessages() {
    const list = document.getElementById('msgList');
    list.innerHTML = '';
    const ts = now();
    loadMessages().forEach(m => {
      const u = USERS[m.userId] || { name:'æœªçŸ¥', avatar:'ğŸ™‚' };
      const remainMs = (m.time + EXPIRY_HOURS * 3600 * 1000) - ts;

      const li = document.createElement('li');
      li.className = 'msg';
      li.innerHTML = `
        <div class="avatar">${u.avatar}</div>
        <div>
          <div><strong>${u.name}ï¼š</strong>${m.text}</div>
          <div class="meta">å‰©ä½™ ${formatRemaining(remainMs)}</div>
        </div>
      `;
      list.appendChild(li);
    });
  }

  // ---- åœ¨çº¿çŠ¶æ€ï¼šå¿ƒè·³ + æ¸²æŸ“ ----
  function readPresence() {
    return safeParse(localStorage.getItem(PRESENCE_KEY), {});
  }

  function writePresence(p) {
    localStorage.setItem(PRESENCE_KEY, JSON.stringify(p));
  }

  function heartbeat() {
    if (!currentUser) return;
    const p = readPresence();
    p[currentUser.id] = now();
    writePresence(p);
  }

  function renderPresence() {
    const p = readPresence();
    const container = document.getElementById('presenceList');
    container.innerHTML = '';
    const ts = now();

    Object.values(USERS).forEach(u => {
      const last = p[u.id] || 0;
      const online = ts - last <= ONLINE_WINDOW_MS;
      const div = document.createElement('div');
      div.className = 'presence-item';
      div.innerHTML = `
        <div class="avatar">${u.avatar}</div>
        <div style="flex:1;">
          <div class="name"><span class="dot ${online ? 'online' : 'offline'}"></span>${u.name} Â· ${online ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
          <div class="muted">${last ? 'ä¸Šæ¬¡æ´»è·ƒï¼š' + timeAgo(ts - last) : 'å°šæœªä¸Šçº¿'}</div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // ---- ç½‘ç»œçŠ¶æ€ ----
  function updateNetwork() {
    const el = document.getElementById('netStatus');
    const online = navigator.onLine;
    el.innerHTML = `<span class="dot ${online ? 'online' : 'offline'}"></span>${online ? 'ç½‘ç»œæ­£å¸¸' : 'ç½‘ç»œç¦»çº¿'}`;
  }

  // ---- ç™»å½•ä¸äº‹ä»¶ ----
  document.getElementById('loginForm').addEventListener('submit', e => {
    e.preventDefault();
    const pwd = document.getElementById('pwd').value.trim();
    const uid = PASSWORDS[pwd];
    if (!uid) return alert('å¯†ç é”™è¯¯');
    currentUser = USERS[uid];

    // åˆ‡æ¢ç•Œé¢
    document.getElementById('loginArea').style.display = 'none';
    document.getElementById('boardArea').style.display = 'block';
    document.getElementById('meAvatar').textContent = currentUser.avatar;
    document.getElementById('meName').textContent = currentUser.name;

    // åˆæ¬¡æ¸²æŸ“
    updateNetwork();
    renderPresence();
    renderMessages();

    // å¿ƒè·³ï¼šå‘ŠçŸ¥â€œæˆ‘åœ¨çº¿â€
    heartbeat();
    setInterval(heartbeat, 15000);     // æ¯ 15 ç§’æ›´æ–°ä¸€æ¬¡åœ¨çº¿çŠ¶æ€
    setInterval(renderPresence, 15000);// åŒæ­¥åˆ·æ–°åœ¨çº¿åˆ—è¡¨
    setInterval(renderMessages, 60000);// æ¯åˆ†é’Ÿåˆ·æ–°å€’è®¡æ—¶
  });

  document.getElementById('msgForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text) return;
    saveMessage(text);
    input.value = '';
    renderMessages();
  });

  // ç½‘ç»œå˜åŒ–äº‹ä»¶
  window.addEventListener('online', updateNetwork);
  window.addEventListener('offline', updateNetwork);

  // è·¨æ ‡ç­¾é¡µåŒæ­¥ï¼ˆåŒä¸€æµè§ˆå™¨çš„ä¸åŒæ ‡ç­¾é¡µï¼‰
  window.addEventListener('storage', (ev) => {
    if (ev.key === PRESENCE_KEY) renderPresence();
    if (ev.key === MSG_KEY) renderMessages();
  });
</script>

</body>
</html>
