<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç›å¡å·´å¡ç•™è¨€æ¿</title>
  <style>
    :root{ --bg:#f7f7fb; --card:#fff; --line:#eaeaea; --text:#222; --muted:#666; --accent:#4f46e5; }
    *{ box-sizing:border-box; }
    body{ font-family: system-ui,-apple-system,'Segoe UI',Roboto,'PingFang SC','Noto Sans SC',sans-serif; margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:840px; margin:24px auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    h2{ margin:0; font-size:20px; }
    .userbox{ display:flex; align-items:center; gap:10px; }
    .avatar{ width:40px; height:40px; border-radius:10px; display:grid; place-items:center; font-size:22px; background:#eef2ff; }
    .name{ font-weight:700; }
    .muted{ color:var(--muted); font-size:12px; }
    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .presence{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .presence .pill{ display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .presence .pill .dot{ width:8px; height:8px; border-radius:50%; background:#22c55e; }
    .composer{ display:flex; gap:8px; }
    textarea{ flex:1; min-height:80px; padding:10px; border:1px solid var(--line); border-radius:10px; outline:none; font-size:15px; background:#fff; }
    button{ padding:10px 16px; border:0; border-radius:10px; background:var(--accent); color:#fff; cursor:pointer; white-space:nowrap; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    ul#list{ list-style:none; padding:0; margin:12px 0 0 0; }
    li.msg{ display:flex; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff; margin-bottom:10px; }
    .bubble{ flex:1; }
    .meta{ font-size:12px; color:var(--muted); margin:4px 0 0; display:flex; gap:8px; flex-wrap:wrap; }
    /* ç™»å½•æ¡† */
    .login{ max-width:360px; margin:100px auto; }
    .login h3{ margin:0 0 12px; text-align:center; }
    .login .field{ display:flex; gap:8px; }
    input[type=password]{ flex:1; padding:10px; border:1px solid var(--line); border-radius:10px; outline:none; }
    .error{ color:#e11d48; font-size:12px; margin-top:8px; min-height:16px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .actions{ display:flex; gap:8px; }
    .logout{ background:#fff; color:#444; border:1px solid var(--line); }
  </style>
</head>
<body>

<!-- ç™»å½•è§†å›¾ -->
<div id="loginView" class="wrap">
  <div class="card login">
    <h3>ç›å¡å·´å¡ç•™è¨€æ¿ Â· å¯†ç ç™»å½•</h3>
    <div class="muted" style="margin-bottom:10px;">â­=â­=â­=â­=â­=â­=â­=â­=â­=â­=â­=â­=â­=â­</div>
    <div class="field">
      <input id="pwd" type="password" placeholder="è¾“å…¥å¯†ç ï¼Œä¾‹å¦‚ï¼šå¤©ä¸Šæœ‰å‡ é¢—æ˜Ÿæ˜Ÿï¼Ÿ" />
      <button id="loginBtn">è¿›å…¥</button>
    </div>
    <div id="loginErr" class="error"></div>
  </div>
</div>

<!-- ä¸»è§†å›¾ -->
<div id="mainView" class="wrap" style="display:none;">
  <div class="card">
    <div class="topbar">
      <div class="userbox">
        <div id="meAvatar" class="avatar">ğŸ™‚</div>
        <div>
          <div id="meName" class="name">æœªçŸ¥</div>
          <div class="muted">ç•™è¨€ä¼šåœ¨ 48 å°æ—¶åè‡ªåŠ¨æ¸…é™¤</div>
        </div>
      </div>
      <div class="actions">
        <button id="logoutBtn" class="logout">é€€å‡º</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="name">å½“å‰åœ¨çº¿</div>
      <div class="muted">1 åˆ†é’Ÿå†…æ´»è·ƒè§†ä¸ºåœ¨çº¿</div>
    </div>
    <div id="presence" class="presence" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <form id="form" class="composer" autocomplete="off">
      <textarea id="text" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯ï¼ˆä¸é™åˆ¶å­—æ•°ï¼‰"></textarea>
      <button id="send" type="submit">å‘é€</button>
    </form>
  </div>

  <ul id="list"></ul>
</div>

<!-- Firebase SDKï¼ˆCompat ç‰ˆï¼Œé€‚åˆé™æ€ç«™ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  // ç”¨æˆ·ä¸å¯†ç æ˜ å°„ï¼ˆæŒ‰ä½ çš„è¦æ±‚ï¼‰
  const USERS = {
    horse:  { id:'horse',  name:'é©¬',   avatar:'ğŸ' },
    sheep:  { id:'sheep',  name:'ç¾Š',   avatar:'ğŸ‘' },
    mouse:  { id:'mouse',  name:'è€é¼ ', avatar:'ğŸ­' },
    rabbit: { id:'rabbit', name:'å…”å­', avatar:'ğŸ‡' },
    monkey: { id:'monkey', name:'çŒ´å­', avatar:'ğŸ’' },
    snake:  { id:'snake',  name:'è›‡',   avatar:'ğŸ' } // å¦‚éœ€å¯ç”¨è›‡ï¼Œå¯¹åº”å¯†ç  she123
  };
  const PASSWORDS = {
    'ma123':'horse',
    'yang123':'sheep',
    'shu123':'mouse',
    'tu123':'rabbit',
    'hou123':'monkey',
    'she123':'snake' // ä½ ä¹‹å‰ä¹Ÿæè¿‡â€œè›‡â€ï¼Œä¿ç•™æ˜ å°„ï¼›ä¸ç”¨å¯å¿½ç•¥
  };

  // Firebase é…ç½®ï¼ˆä½¿ç”¨ä½ çš„é¡¹ç›®ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyDTsjNPdZntfabyVn0q-9y39l9a1ur_cEw",
    authDomain: "jiatingliuyanban-635f9.firebaseapp.com",
    databaseURL: "https://jiatingliuyanban-635f9-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "jiatingliuyanban-635f9",
    storageBucket: "jiatingliuyanban-635f9.firebasestorage.app",
    messagingSenderId: "196518556157",
    appId: "1:196518556157:web:f710ec71f8acb4eb79a994"
  };

  // å¸¸é‡
  const EXP_MS = 48 * 3600 * 1000;       // 48 å°æ—¶
  const ONLINE_WINDOW = 60 * 1000;       // 1 åˆ†é’Ÿåˆ¤å®šåœ¨çº¿
  const COUNTDOWN_INTERVAL = 60000;      // å€’è®¡æ—¶åˆ·æ–°ï¼šæ¯åˆ†é’Ÿ

  // DOM
  const loginView = document.getElementById('loginView');
  const mainView  = document.getElementById('mainView');
  const pwdInput  = document.getElementById('pwd');
  const loginBtn  = document.getElementById('loginBtn');
  const loginErr  = document.getElementById('loginErr');
  const meAvatar  = document.getElementById('meAvatar');
  const meName    = document.getElementById('meName');
  const logoutBtn = document.getElementById('logoutBtn');
  const form      = document.getElementById('form');
  const textInput = document.getElementById('text');
  const sendBtn   = document.getElementById('send');
  const listEl    = document.getElementById('list');
  const presenceEl= document.getElementById('presence');

  // çŠ¶æ€
  let currentUser = null;
  let db, messagesRef, statusRef, statusAllRef, connectedRef;
  let countdownTimer = null;

  // ç™»å½•é€»è¾‘
  const savedRole = sessionStorage.getItem('roleId');
  if (savedRole && USERS[savedRole]) {
    currentUser = USERS[savedRole];
    showMain();
  }

  loginBtn.addEventListener('click', () => {
    const pwd = (pwdInput.value || '').trim();
    const roleId = PASSWORDS[pwd];
    if (!roleId || !USERS[roleId]) {
      loginErr.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
      return;
    }
    currentUser = USERS[roleId];
    sessionStorage.setItem('roleId', currentUser.id);
    showMain();
  });

  logoutBtn.addEventListener('click', () => {
    // æ¸…é™¤åœ¨çº¿æ ‡è®°
    try { statusRef && statusRef.remove(); } catch(e){}
    sessionStorage.removeItem('roleId');
    // å›åˆ°ç™»å½•é¡µ
    mainView.style.display = 'none';
    loginView.style.display = 'block';
    // åœæ­¢å€’è®¡æ—¶åˆ·æ–°
    if (countdownTimer) clearInterval(countdownTimer);
  });

  function showMain(){
    // UI
    loginView.style.display = 'none';
    mainView.style.display = 'block';
    meAvatar.textContent = currentUser.avatar;
    meName.textContent = currentUser.name;

    // Firebase åˆå§‹åŒ–
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();

    messagesRef   = db.ref('messages');
    statusRef     = db.ref('status/' + currentUser.id);
    statusAllRef  = db.ref('status');
    connectedRef  = db.ref('.info/connected');

    // åœ¨çº¿çŠ¶æ€ï¼šè¿æ¥ä¸å¿ƒè·³
    connectedRef.on('value', snap => {
      if (snap.val() === true) {
        statusRef.onDisconnect().remove();
        statusRef.set({
          uid: currentUser.id,
          name: currentUser.name,
          avatar: currentUser.avatar,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
      }
    });
    setInterval(() => {
      statusRef.update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
    }, 30000);

    // æ¸²æŸ“åœ¨çº¿åå•
    statusAllRef.on('value', snap => {
      const now = Date.now();
      const online = [];
      snap.forEach(child => {
        const v = child.val();
        if (v && v.lastSeen && (now - v.lastSeen) < ONLINE_WINDOW) {
          online.push(v);
        }
      });
      presenceEl.innerHTML = online.length
        ? online.map(v => `<span class="pill"><span class="dot"></span><span>${escapeHtml(v.avatar || '')}</span><b>${escapeHtml(v.name || '')}</b></span>`).join('')
        : '<span class="muted">å½“å‰æ— äººåœ¨çº¿</span>';
    });

    // å‘é€æ¶ˆæ¯ï¼ˆä¸é™åˆ¶å­—æ•°ï¼›ä»…ç©ºå†…å®¹æ‹¦æˆªï¼‰
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = (textInput.value || '').trim();
      if (!text) return;
      sendBtn.disabled = true;
      try {
        await messagesRef.push({
          userId: currentUser.id,
          text,
          ts: firebase.database.ServerValue.TIMESTAMP
        });
        textInput.value = '';
      } finally {
        sendBtn.disabled = false;
      }
    });

    // åˆæ¬¡æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼Œå¹¶å®šæ—¶æ¸…ç†
    cleanupExpired();
    setInterval(cleanupExpired, 10 * 60 * 1000); // æ¯ 10 åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡

    // ç›‘å¬å¹¶æ¸²æŸ“æ¶ˆæ¯ï¼ˆä»…å±•ç¤º 48 å°æ—¶å†…ï¼‰
    const since = Date.now() - EXP_MS;
    messagesRef.orderByChild('ts').startAt(since).limitToLast(500).on('child_added', snap => {
      const m = snap.val();
      renderMessage(snap.key, m);
    });
    messagesRef.on('child_changed', snap => {
      // ä¸éœ€è¦å¤„ç†
    });
    messagesRef.on('child_removed', snap => {
      const el = document.getElementById('msg-' + snap.key);
      if (el) el.remove();
    });

    // å€’è®¡æ—¶åˆ·æ–°
    countdownTimer = setInterval(updateCountdowns, COUNTDOWN_INTERVAL);
  }

  // æ¸²æŸ“å•æ¡æ¶ˆæ¯
  function renderMessage(id, m){
    if (!m || !m.ts) return;
    const age = Date.now() - m.ts;
    if (age >= EXP_MS) return; // è¿‡æœŸä¸æ˜¾ç¤º
    const u = USERS[m.userId] || { name:'æœªçŸ¥', avatar:'ğŸ™‚' };

    let li = document.getElementById('msg-' + id);
    if (!li) {
      li = document.createElement('li');
      li.className = 'msg';
      li.id = 'msg-' + id;
      li.innerHTML = `
        <div class="avatar">${u.avatar}</div>
        <div class="bubble">
          <div><strong>${escapeHtml(u.name)}ï¼š</strong><span class="content"></span></div>
          <div class="meta">
            <span class="time"></span>
            <span class="remain"></span>
          </div>
        </div>
      `;
      listEl.prepend(li);
    }
    li.querySelector('.content').innerHTML = linkify(escapeHtml(m.text));
    li.dataset.ts = m.ts;
    li.querySelector('.time').textContent = new Date(m.ts).toLocaleString();
    updateOneCountdown(li);
  }

  // æ›´æ–°æ‰€æœ‰å€’è®¡æ—¶
  function updateCountdowns(){
    document.querySelectorAll('li.msg').forEach(updateOneCountdown);
  }
  function updateOneCountdown(li){
    const ts = Number(li.dataset.ts || 0);
    if (!ts) return;
    const remain = ts + EXP_MS - Date.now();
    if (remain <= 0) {
      // åˆ°æœŸï¼šè®© UI ç§»é™¤ï¼Œå®é™…åˆ é™¤ç”± cleanupExpired è´Ÿè´£å…œåº•
      li.remove();
      return;
    }
    const txt = formatRemain(remain);
    const el = li.querySelector('.remain');
    if (el) el.textContent = `å‰©ä½™ ${txt}`;
  }
  function formatRemain(ms){
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const hh = String(h).padStart(2,'0');
    const mm = String(m).padStart(2,'0');
    return `${hh}å°æ—¶${mm}åˆ†é’Ÿ`;
  }

  // æ¸…ç†è¿‡æœŸæ¶ˆæ¯ï¼ˆç®€å•å®¢æˆ·ç«¯æ¸…ç†ï¼‰
  function cleanupExpired(){
    const cutoff = Date.now() - EXP_MS;
    messagesRef.orderByChild('ts').endAt(cutoff).once('value', snap => {
      snap.forEach(child => child.ref.remove());
    });
  }

  // å·¥å…·å‡½æ•°
  function escapeHtml(s){
    return String(s).replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]));
  }
  function linkify(s){
    return s.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  }
</script>
</body>
</html>





