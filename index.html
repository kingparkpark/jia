<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç›å¡å·´å¡ç•™è¨€æ¿</title>
  <style>
    :root{ --bg:#f7f7fb; --card:#fff; --line:#eaeaea; --text:#222; --muted:#666; --accent:#4f46e5; }
    *{ box-sizing:border-box; }
    body{ font-family: system-ui,-apple-system,'Segoe UI',Roboto,'PingFang SC','Noto Sans SC',sans-serif; margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:840px; margin:24px auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); margin-bottom:20px; }
    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    h2,h3{ margin:0; }
    .userbox{ display:flex; align-items:center; gap:10px; }
    .avatar{ width:40px; height:40px; border-radius:10px; display:grid; place-items:center; font-size:22px; background:#eef2ff; }
    .name{ font-weight:700; }
    .muted{ color:var(--muted); font-size:12px; }
    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .presence{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .presence .pill{ display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .presence .pill .dot{ width:8px; height:8px; border-radius:50%; background:#22c55e; }
    .composer{ display:flex; gap:8px; }
    textarea{ flex:1; min-height:80px; padding:10px; border:1px solid var(--line); border-radius:10px; outline:none; font-size:15px; background:#fff; }
    button{ padding:10px 16px; border:0; border-radius:10px; background:var(--accent); color:#fff; cursor:pointer; white-space:nowrap; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    ul#list{ list-style:none; padding:0; margin:12px 0 0 0; }
    li.msg{ display:flex; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff; margin-bottom:10px; }
    .bubble{ flex:1; }
    .meta{ font-size:12px; color:var(--muted); margin:4px 0 0; display:flex; gap:8px; flex-wrap:wrap; }

    /* ç™»å½•æ¡† */
    .login{ max-width:360px; margin:100px auto; }
    .login h3{ margin:0 0 12px; text-align:center; }
    .login .field{ display:flex; gap:8px; }
    input[type=password]{ flex:1; padding:10px; border:1px solid var(--line); border-radius:10px; outline:none; }
    .error{ color:#e11d48; font-size:12px; margin-top:8px; min-height:16px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .actions{ display:flex; gap:8px; }
    .logout{ background:#fff; color:#444; border:1px solid var(--line); }

    /* å¼€å¥–æ¨¡å— */
    select { padding:6px; font-size:14px; margin-bottom:10px; }
    .zodiac { font-size:18px; margin-top:4px; }
    .countdown { font-weight:bold; color:#d00; margin-top:6px; }
  </style>
</head>
<body>

  <!-- ç™»å½•è§†å›¾ -->
  <div id="loginView" class="wrap">
    <div class="card login">
      <h3>ç›å¡å·´å¡ç•™è¨€æ¿ Â· å¯†ç ç™»å½•</h3>
      <div class="muted" style="margin-bottom:10px;">â­=â­=â­=â­=â­=â­=â­=â­=â­=â­=â­=â­=â­</div>
      <div class="field">
        <input id="pwd" type="password" placeholder="è¾“å…¥å¯†ç ï¼Œä¾‹å¦‚ï¼šå¤©ä¸Šæœ‰å‡ é¢—æ˜Ÿæ˜Ÿï¼Ÿ" />
        <button id="loginBtn">è¿›å…¥</button>
      </div>
      <div id="loginErr" class="error"></div>
    </div>
  </div>

  <!-- ä¸»è§†å›¾ -->
  <div id="mainView" class="wrap" style="display:none;">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="card">
      <div class="topbar">
        <div class="userbox">
          <div id="meAvatar" class="avatar">ğŸ™‚</div>
          <div>
            <div id="meName" class="name">æœªçŸ¥</div>
            <div class="muted">ç•™è¨€ä¼šåœ¨ 48 å°æ—¶åè‡ªåŠ¨æ¸…é™¤</div>
          </div>
        </div>
        <div class="actions">
          <button id="logoutBtn" class="logout">é€€å‡º</button>
        </div>
      </div>
    </div>

    <!-- åœ¨çº¿åˆ—è¡¨ -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="name">å½“å‰åœ¨çº¿</div>
        <div class="muted">1 åˆ†é’Ÿå†…æ´»è·ƒè§†ä¸ºåœ¨çº¿</div>
      </div>
      <div id="presence" class="presence" style="margin-top:8px;"></div>
    </div>

    <!-- å¼€å¥–èµ„è®¯æ¨¡å— -->
    <div class="card">
      <h3>ğŸ§§ å¼€å¥–èµ„è®¯</h3>
      <label for="gameSelect">é€‰æ‹©æ¸¸æˆï¼š</label>
      <select id="gameSelect">
        <option value="1">é¦™æ¸¯</option>
        <option value="2">å°æ¹¾</option>
        <option value="3">è€æ¾³é—¨</option>
        <option value="4">æ–°æ¾³é—¨</option>
        <option value="5">æ’åˆ—5</option>
      </select>
      <div id="lotteryInfo">è½½å…¥ä¸­...</div>
      <div id="countdown" class="countdown"></div>
    </div>

    <!-- ç•™è¨€è¾“å…¥ -->
    <div class="card">
      <form id="form" class="composer" autocomplete="off">
        <textarea id="text" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯ï¼ˆä¸é™åˆ¶å­—æ•°ï¼‰"></textarea>
        <button id="send" type="submit">å‘é€</button>
      </form>
    </div>

    <!-- ç•™è¨€åˆ—è¡¨ -->
    <ul id="list"></ul>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // â€”â€” ç”¨æˆ· & å¯†ç æ˜ å°„ â€”â€”
    const USERS = {
      horse:  { id:'horse',  name:'é©¬',   avatar:'ğŸ' },
      sheep:  { id:'sheep',  name:'ç¾Š',   avatar:'ğŸ‘' },
      mouse:  { id:'mouse',  name:'è€é¼ ', avatar:'ğŸ­' },
      rabbit: { id:'rabbit', name:'å…”å­', avatar:'ğŸ‡' },
      monkey: { id:'monkey', name:'çŒ´å­', avatar:'ğŸ’' },
      snake:  { id:'snake',  name:'è›‡',   avatar:'ğŸ' }
    };
    const PASSWORDS = {
      'ma123':'horse',
      'yang123':'sheep',
      'shu123':'mouse',
      'tu123':'rabbit',
      'hou123':'monkey',
      'she123':'snake'
    };

    // â€”â€” Firebase é…ç½® â€”â€”
    const firebaseConfig = {
      apiKey: "AIzaSyDTsjNPdZntfabyVn0q-9y39l9a1ur_cEw",
      authDomain: "jiatingliuyanban-635f9.firebaseapp.com",
      databaseURL: "https://jiatingliuyanban-635f9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "jiatingliuyanban-635f9",
      storageBucket: "jiatingliuyanban-635f9.appspot.com",
      messagingSenderId: "196518556157",
      appId: "1:196518556157:web:f710ec71f8acb4eb79a994"
    };

    // â€”â€” å¸¸é‡ â€”â€”
    const EXP_MS = 48 * 3600 * 1000;       // ç•™è¨€è¿‡æœŸ 48h
    const ONLINE_WINDOW = 60 * 1000;      // åœ¨çº¿åˆ¤å®š 1min
    const COUNTDOWN_INTERVAL = 60000;     // ç•™è¨€å€’è®¡æ—¶åˆ·æ–° 1min

    // â€”â€” ç”Ÿè‚– emoji æ˜ å°„ â€”â€” 
    const zodiacEmoji = {
      "é¼ ":"ğŸ­","ç‰›":"ğŸ®","è™":"ğŸ¯","å…”":"ğŸ°",
      "é¾":"ğŸ²","è›‡":"ğŸ","é¦¬":"ğŸ´","ç¾Š":"ğŸ‘",
      "çŒ´":"ğŸµ","é›":"ğŸ”","ç‹—":"ğŸ¶","è±¬":"ğŸ·"
    };

    // â€”â€” DOM å¼•ç”¨ â€”â€”
    const loginView  = document.getElementById('loginView');
    const mainView   = document.getElementById('mainView');
    const pwdInput   = document.getElementById('pwd');
    const loginBtn   = document.getElementById('loginBtn');
    const loginErr   = document.getElementById('loginErr');
    const meAvatar   = document.getElementById('meAvatar');
    const meName     = document.getElementById('meName');
    const logoutBtn  = document.getElementById('logoutBtn');
    const form       = document.getElementById('form');
    const textInput  = document.getElementById('text');
    const sendBtn    = document.getElementById('send');
    const listEl     = document.getElementById('list');
    const presenceEl = document.getElementById('presence');
    const gameSelect = document.getElementById('gameSelect');
    const lotteryInfo= document.getElementById('lotteryInfo');
    const countdownEl= document.getElementById('countdown');

    // â€”â€” çŠ¶æ€å˜é‡ â€”â€”
    let currentUser = null;
    let db, messagesRef, statusRef, statusAllRef, connectedRef;
    let messageTimer = null;

    // â€”â€” è‡ªåŠ¨ç™»å½•æ£€æµ‹ â€”â€”
    const savedRole = sessionStorage.getItem('roleId');
    if (savedRole && USERS[savedRole]) {
      currentUser = USERS[savedRole];
      showMain();
    }

    // â€”â€” ç™»å½•äº‹ä»¶ â€”â€”
    loginBtn.addEventListener('click', () => {
      const pwd = (pwdInput.value || '').trim();
      const roleId = PASSWORDS[pwd];
      if (!roleId || !USERS[roleId]) {
        loginErr.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
        return;
      }
      currentUser = USERS[roleId];
      sessionStorage.setItem('roleId', currentUser.id);
      showMain();
    });

    // â€”â€” é€€å‡ºäº‹ä»¶ â€”â€”
    logoutBtn.addEventListener('click', () => {
      try { statusRef && statusRef.remove(); } catch(e){}
      sessionStorage.removeItem('roleId');
      mainView.style.display = 'none';
      loginView.style.display = 'block';
      if (messageTimer) clearInterval(messageTimer);
    });

    // â€”â€” æ˜¾ç¤ºä¸»ç•Œé¢ & åˆå§‹åŒ– Firebase & ç›‘å¬æ¶ˆæ¯ & åœ¨çº¿ & å¼€å¥– â€”â€” 
    function showMain(){
      loginView.style.display = 'none';
      mainView.style.display = 'block';
      meAvatar.textContent = currentUser.avatar;
      meName.textContent   = currentUser.name;

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      db            = firebase.database();
      messagesRef   = db.ref('messages');
      statusRef     = db.ref('status/' + currentUser.id);
      statusAllRef  = db.ref('status');
      connectedRef  = db.ref('.info/connected');

      // â€”â€” åœ¨çº¿çŠ¶æ€å¿ƒè·³ â€”â€”
      connectedRef.on('value', snap => {
        if (snap.val() === true) {
          statusRef.onDisconnect().remove();
          statusRef.set({ uid:currentUser.id, name:currentUser.name,
                          avatar:currentUser.avatar,
                          lastSeen:firebase.database.ServerValue.TIMESTAMP });
        }
      });
      setInterval(() => {
        statusRef.update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
      }, 30000);

      // â€”â€” æ¸²æŸ“åœ¨çº¿ç”¨æˆ· â€”â€”
      statusAllRef.on('value', snap => {
        const now = Date.now();
        const online = [];
        snap.forEach(ch => {
          const v = ch.val();
          if (v.lastSeen && (now - v.lastSeen) < ONLINE_WINDOW) {
            online.push(v);
          }
        });
        presenceEl.innerHTML = online.length
          ? online.map(v => `<span class="pill"><span class="dot"></span><span>${v.avatar}</span><b>${v.name}</b></span>`).join('')
          : '<span class="muted">å½“å‰æ— äººåœ¨çº¿</span>';
      });

      // â€”â€” å‘é€æ¶ˆæ¯ â€”â€”
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const txt = (textInput.value||'').trim();
        if (!txt) return;
        sendBtn.disabled = true;
        try {
          await messagesRef.push({ userId:currentUser.id,
                                   text:txt,
                                   ts:firebase.database.ServerValue.TIMESTAMP });
          textInput.value = '';
        } finally {
          sendBtn.disabled = false;
        }
      });

      // â€”â€” æ¸…ç† & ç›‘å¬ & æ¸²æŸ“ç•™è¨€ â€”â€”
      cleanupExpired();
      messageTimer = setInterval(cleanupExpired, 10*60*1000);

      const since = Date.now() - EXP_MS;
      messagesRef.orderByChild('ts').startAt(since).limitToLast(500)
        .on('child_added', snap => renderMessage(snap.key, snap.val()));
      messagesRef.on('child_removed', snap => {
        const el = document.getElementById('msg-'+snap.key);
        if(el) el.remove();
      });

      // â€”â€” ç•™è¨€å€’è®¡æ—¶æ›´æ–° â€”â€”
      setInterval(updateAllMessageCountdowns, COUNTDOWN_INTERVAL);

      // â€”â€” åˆå§‹åŒ– & ç›‘å¬å¼€å¥–æ¨¡å— â€”â€”
      gameSelect.addEventListener('change', () => loadLottery(gameSelect.value));
      loadLottery(gameSelect.value);
    }

    // â€”â€” æ¸²æŸ“å•æ¡ç•™è¨€ â€”â€”
    function renderMessage(id, m){
      if(!m || !m.ts) return;
      const age = Date.now() - m.ts;
      if(age >= EXP_MS) return;
      let li = document.getElementById('msg-'+id);
      if(!li){
        li = document.createElement('li');
        li.id = 'msg-'+id; li.className='msg';
        li.innerHTML = `
          <div class="avatar">${USERS[m.userId]?.avatar||'ğŸ™‚'}</div>
          <div class="bubble">
            <div><strong>${USERS[m.userId]?.name||'æœªçŸ¥'}ï¼š</strong><span class="content"></span></div>
            <div class="meta"><span class="time"></span> <span class="remain"></span></div>
          </div>`;
        listEl.prepend(li);
      }
      li.querySelector('.content').textContent = m.text;
      li.dataset.ts = m.ts;
      li.querySelector('.time').textContent = new Date(m.ts).toLocaleString();
      updateMessageCountdown(li);
    }

    // â€”â€” æ›´æ–°æ‰€æœ‰ç•™è¨€å‰©ä½™æ—¶é•¿ â€”â€”
    function updateAllMessageCountdowns(){
      document.querySelectorAll('li.msg').forEach(updateMessageCountdown);
    }
    function updateMessageCountdown(li){
      const ts = Number(li.dataset.ts);
      const remain = ts + EXP_MS - Date.now();
      if(remain <= 0){ li.remove(); return; }
      const s = Math.floor(remain/1000);
      const h = String(Math.floor(s/3600)).padStart(2,'0');
      const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
      li.querySelector('.remain').textContent = `å‰©ä½™ ${h}å°æ—¶${m}åˆ†é’Ÿ`;
    }

    // â€”â€” å®¢æˆ·ç«¯æ¸…ç†è¿‡æœŸç•™è¨€ â€”â€”
    function cleanupExpired(){
      const cutoff = Date.now() - EXP_MS;
      messagesRef.orderByChild('ts').endAt(cutoff)
        .once('value', snap => snap.forEach(ch => ch.ref.remove()));
    }

    // â€”â€” åŠ è½½å¼€å¥–æ•°æ® & æ¸²æŸ“ â€”â€”
    async function loadLottery(gameid){
      lotteryInfo.textContent = 'è½½å…¥ä¸­...';
      try {
        const res = await fetch(`https://api.166001.com/lottery/get/${gameid}`);
        const json = await res.json();
        const d = json.data;
        if(!d){ lotteryInfo.textContent='è·å–å¤±è´¥'; return; }

        const zodiacHtml = d.currentZodiac
          ? d.currentZodiac.split(',').map(z => `${zodiacEmoji[z]||''}${z}`).join(', ')
          : '';
        const last3 = d.resultsOfLastThreeIssues.map(r => {
          const zs = r.zodiac
            ? r.zodiac.split(',').map(z => `${zodiacEmoji[z]||''}${z}`).join(', ')
            : '';
          return `<li>
            <strong>${r.issue}</strong>ï¼š${r.result}
            ${zs?`<div class="zodiac">${zs}</div>`:''}
            <div class="muted">${r.creatTime}</div>
          </li>`;
        }).join('');

        lotteryInfo.innerHTML = `
          <div>æœŸå·ï¼š${d.currentIssue||'â€”'}</div>
          <div>å¼€å¥–ï¼š${d.currentResult||'â€”'}</div>
          ${zodiacHtml?`<div class="zodiac">ç”Ÿè‚–ï¼š${zodiacHtml}</div>`:''}
          <div>ä¸‹ä¸€æœŸï¼š${d.nextIssue}ï¼ˆ${d.nextTime}ï¼‰</div>
          <hr>
          <div>æœ€è¿‘ä¸‰æœŸï¼š</div>
          <ul style="padding-left:16px;">${last3}</ul>
        `;
        startLotteryCountdown(d.nextTime);
      } catch(e){
        console.error(e);
        lotteryInfo.textContent = 'è½½å…¥å¤±è´¥';
      }
    }

    // â€”â€” å¼€å¥–å€’è®¡æ—¶ â€”â€”
    let lotteryTimer = null;
    function startLotteryCountdown(nextTimeStr){
      if(lotteryTimer) clearTimeout(lotteryTimer);
      function tick(){
        const target = new Date(nextTimeStr.replace(/-/g,'/')).getTime();
        const diff = target - Date.now();
        if(diff <= 0){
          countdownEl.textContent = 'ğŸ‰ æ­£åœ¨å¼€å¥–æˆ–å·²å¼€å¥–ï¼';
        } else {
          const m = Math.floor(diff/60000);
          const s = Math.floor((diff%60000)/1000);
          countdownEl.textContent = `â³ è·ç¦»ä¸‹æœŸå¼€å¥–ï¼š${m}åˆ†${s}ç§’`;
          lotteryTimer = setTimeout(tick, 1000);
        }
      }
      tick();
    }
  </script>
</body>
</html>

